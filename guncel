#!/usr/bin/env bash
#
# ARCB Wider Updater v3.3.6 - Diamond Polish Edition
# "MÃ¼kemmellik, ekleyecek bir ÅŸey kalmadÄ±ÄŸÄ±nda deÄŸil,
#  Ã§Ä±karacak bir ÅŸey kalmadÄ±ÄŸÄ±nda ulaÅŸÄ±lÄ±r."
#
# GitHub: https://github.com/ahm3t0t/arcb-wider-updater
#

# --- AYARLAR ---
VERSION="3.3.6"
LOG_DIR="/var/log/arcb-updater"
LOG_FILE="$LOG_DIR/update_$(date +%Y%m%d_%H%M%S).log"
GITHUB_RAW_URL="https://raw.githubusercontent.com/ahm3t0t/arcb-wider-updater/main/guncel"

# STRICT MODE
set -Eeuo pipefail

# GÃœVENLÄ°K: VarsayÄ±lan dosya izinleri (Sadece sahibi okur/yazar)
umask 0077

# Renkler
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

# --- YARDIMCI FONKSÄ°YONLAR ---

print_header() {
    echo -e "\n${BLUE}${BOLD}>>> $1 ${NC}"
    echo -e "${BLUE}--------------------------------------------------${NC}"
    echo "[$(date '+%F %T')] >>> $1" >> "$LOG_FILE"
}

print_error() {
    echo -e "${RED}${BOLD}âŒ HATA: $1 ${NC}"
    echo "[$(date '+%F %T')] ERROR: $1" >> "$LOG_FILE"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  UYARI: $1 ${NC}"
    echo "[$(date '+%F %T')] WARN: $1" >> "$LOG_FILE"
}

print_success() {
    echo -e "${GREEN}${BOLD}âœ… $1 ${NC}"
    echo "[$(date '+%F %T')] SUCCESS: $1" >> "$LOG_FILE"
}

download_file() {
    local url="$1"
    local output="$2"
    
    if command -v curl &> /dev/null; then
        curl -fsSL "$url" -o "$output"
    elif command -v wget &> /dev/null; then
        wget -qO "$output" "$url"
    else
        print_error "Sistemde 'curl' veya 'wget' bulunamadÄ±!"
        exit 1
    fi
}

check_connectivity() {
    echo -ne "${YELLOW}ðŸŒ BaÄŸlantÄ± kontrol ediliyor... ${NC}"
    local UA="Mozilla/5.0 (compat; ARCBUpdater/$VERSION)"
    
    # 1. Genel Ä°nternet
    local main_ok=false
    if command -v curl &> /dev/null; then
        if curl -s -I -f -L -A "$UA" https://github.com > /dev/null; then main_ok=true; fi
    elif command -v wget &> /dev/null; then
        if wget -q --spider --user-agent="$UA" https://github.com; then main_ok=true; fi
    fi

    if [[ "$main_ok" == "false" ]]; then
        echo -e "${RED}EriÅŸim Yok!${NC}"
        return 1
    fi

    # 2. Raw Endpoint
    local raw_ok=false
    if command -v curl &> /dev/null; then
        if curl -s -I -f -L -A "$UA" "$GITHUB_RAW_URL" > /dev/null; then raw_ok=true; fi
    elif command -v wget &> /dev/null; then
        if wget -q --spider --user-agent="$UA" "$GITHUB_RAW_URL"; then raw_ok=true; fi
    fi
    
    if [[ "$raw_ok" == "true" ]]; then
        echo -e "${GREEN}BaÄŸlÄ± (Full).${NC}"
        return 0
    else
        echo -e "${YELLOW}KÄ±smi (Raw eriÅŸimi yok).${NC}"
        print_warning "Repo dosyalarÄ±na eriÅŸilemiyor. Self-update devre dÄ±ÅŸÄ±."
        export SELF_UPDATE_DISABLED="true"
        return 0
    fi
}

check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${YELLOW}ðŸ”’ Root yetkisi gerekiyor...${NC}"
        if command -v sudo &> /dev/null; then
            exec sudo "$0" "$@"
        else
            print_error "Sudo yok ve root deÄŸilsin."
            exit 1
        fi
    fi
}

setup_logging() {
    if [ ! -d "$LOG_DIR" ]; then
        mkdir -p "$LOG_DIR"
    fi
    
    local deleted_count
    deleted_count=$(find "$LOG_DIR" -name "update_*.log" -type f -mtime +30 -print -delete | wc -l)
    
    touch "$LOG_FILE"
    # umask 0077 olduÄŸu iÃ§in zaten 600 oluÅŸur ama garanti olsun
    chmod 600 "$LOG_FILE"
    
    if [[ "$deleted_count" -gt 0 ]]; then
        echo "[$(date '+%F %T')] INFO: $deleted_count adet eski log dosyasÄ± temizlendi." >> "$LOG_FILE"
    fi
}

check_self_update() {
    if [[ "${SELF_UPDATE_DISABLED:-false}" == "true" ]]; then return; fi

    local REMOTE_FILE="/tmp/guncel_remote"
    local REMOTE_HASH
    local LOCAL_HASH
    
    if ! download_file "$GITHUB_RAW_URL" "$REMOTE_FILE"; then return; fi

    if ! grep -q "ARCB Wider Updater" "$REMOTE_FILE"; then
        print_warning "Ä°ndirilen dosya geÃ§ersiz. Self-update iptal."
        rm -f "$REMOTE_FILE"
        return
    fi
    if ! head -n 1 "$REMOTE_FILE" | grep -E -q "#!/(usr/)?bin/(env )?bash"; then
         print_warning "Ä°ndirilen dosya geÃ§erli bir bash script deÄŸil."
         rm -f "$REMOTE_FILE"
         return
    fi

    REMOTE_HASH=$(sha256sum "$REMOTE_FILE" | awk '{print $1}')
    LOCAL_HASH=$(sha256sum "$0" | awk '{print $1}')

    if [[ "$REMOTE_HASH" != "$LOCAL_HASH" && -n "$REMOTE_HASH" ]]; then
        echo -e "\n${YELLOW}ðŸ’¡ Yeni sÃ¼rÃ¼m mevcut!${NC}"
        if [[ "${AUTO_MODE:-false}" == "true" ]]; then
             REPLY="e"
        else
             read -p "   GÃ¼ncellemek ister misin? (e/H): " -n 1 -r
             echo
        fi

        if [[ ${REPLY:-H} =~ ^[Ee]$ ]]; then
            print_header "Self-Update BaÅŸlatÄ±lÄ±yor..."
            if install -m 0755 "$REMOTE_FILE" "$0"; then
                print_success "Script gÃ¼ncellendi. Yeniden baÅŸlatÄ±lÄ±yor..."
                exec "$0" "$@"
            else
                print_error "GÃ¼ncelleme kopyalanamadÄ±!"
                exit 1
            fi
        fi
    fi
    rm -f "$REMOTE_FILE"
}

wait_for_lock() {
    local has_checker="false"
    if command -v fuser &> /dev/null; then has_checker="fuser";
    elif command -v lsof &> /dev/null; then has_checker="lsof"; fi

    if [[ "$has_checker" == "false" ]]; then
        print_warning "Kilit kontrol aracÄ± (fuser/lsof) bulunamadÄ±, kontrol atlanÄ±yor."
        return
    fi

    local max_retries=15
    local count=0
    local lock_files=("/var/lib/dpkg/lock" "/var/lib/dpkg/lock-frontend" "/var/lib/apt/lists/lock" "/var/cache/apt/archives/lock")
    
    while true; do
        local locked=false
        for lock in "${lock_files[@]}"; do
            if [[ "$has_checker" == "fuser" ]]; then
                if fuser "$lock" >/dev/null 2>&1; then locked=true; break; fi
            elif [[ "$has_checker" == "lsof" ]]; then
                if lsof "$lock" >/dev/null 2>&1; then locked=true; break; fi
            fi
        done

        if [[ "$locked" == "false" ]]; then break; fi

        if [ $count -ge $max_retries ]; then
            print_error "APT kilitleri kaldÄ±rÄ±lamadÄ±. Manuel mÃ¼dahale gerek."
            exit 1
        fi
        
        echo -e "${YELLOW}â³ APT kilitli ($has_checker), bekleniyor... ($count/$max_retries)${NC}"
        sleep 5
        ((count++))
    done
}

create_snapshot() {
    if command -v timeshift &> /dev/null; then
        print_header "Sistem Yedekleniyor (Timeshift)"
        timeshift --create --comments "ARCB-Update-$(date +%F)" --tags D 2>&1 | tee -a "$LOG_FILE"
        return
    fi

    if command -v snapper &> /dev/null; then
        print_header "Sistem Yedekleniyor (Snapper)"
        if snapper create --description "ARCB-Update-$(date +%F)" --cleanup-algorithm number 2>&1 | tee -a "$LOG_FILE"; then
             print_success "Snapper snapshot oluÅŸturuldu."
        else
             print_warning "Snapper snapshot oluÅŸturulamadÄ±."
        fi
        return
    fi

    echo "[$(date '+%F %T')] INFO: Yedekleme aracÄ± bulunamadÄ±." >> "$LOG_FILE"
    if [[ "${AUTO_MODE:-false}" != "true" ]]; then
         echo -e "${YELLOW}â„¹ï¸  Timeshift veya Snapper bulunamadÄ±, yedekleme yapÄ±lmÄ±yor.${NC}"
    fi
}

perform_updates() {
    local apt_opts=()
    if [[ "${AUTO_MODE:-false}" == "true" ]]; then
        export DEBIAN_FRONTEND=noninteractive
        apt_opts=(-o "Dpkg::Options::=--force-confdef" -o "Dpkg::Options::=--force-confold")
    fi

    # A. APT
    if command -v apt-get &> /dev/null; then
        wait_for_lock
        print_header "APT: GÃ¼ncelleme BaÅŸlÄ±yor"
        apt-get update 2>&1 | tee -a "$LOG_FILE"
        print_header "APT: Dist-Upgrade"
        apt-get dist-upgrade -y "${apt_opts[@]}" 2>&1 | tee -a "$LOG_FILE"
        print_header "APT: Temizlik"
        # FIX: Temizlik komutlarÄ±na da noninteractive seÃ§enekleri eklendi
        apt-get autoremove -y "${apt_opts[@]}" 2>&1 | tee -a "$LOG_FILE"
        apt-get autoclean -y "${apt_opts[@]}" 2>&1 | tee -a "$LOG_FILE"

    # B. DNF
    elif command -v dnf &> /dev/null; then
        print_header "DNF: GÃ¼ncelleme"
        dnf upgrade --refresh -y 2>&1 | tee -a "$LOG_FILE"
    fi

    # C. Flatpak
    if command -v flatpak &> /dev/null; then
        print_header "Flatpak: GÃ¼ncelleme"
        if ! flatpak update -y 2>&1 | tee -a "$LOG_FILE"; then
            print_warning "Flatpak update hatasÄ±."
        else
            flatpak uninstall --unused -y 2>&1 | tee -a "$LOG_FILE" || true
        fi
    fi

    # D. Snap
    if command -v snap &> /dev/null; then
        print_header "Snap: GÃ¼ncelleme"
        if ! snap refresh 2>&1 | tee -a "$LOG_FILE"; then
            print_warning "Snap refresh hatasÄ±."
        fi
    fi
    
    # E. Firmware
    if command -v fwupdmgr &> /dev/null; then
        print_header "Firmware: Kontrol"
        if [[ "${AUTO_MODE:-false}" == "true" ]]; then
            # Auto modda sessiz
            { fwupdmgr refresh --force || true; fwupdmgr update -y || true; } >> "$LOG_FILE" 2>&1
            echo -e "${GREEN}TamamlandÄ± (Detaylar log dosyasÄ±nda).${NC}"
        else
            fwupdmgr refresh --force 2>&1 | tee -a "$LOG_FILE" || true
            fwupdmgr update -y 2>&1 | tee -a "$LOG_FILE" || true
        fi
    fi
}

# --- MAIN ---

AUTO_MODE="false"
for arg in "$@"; do
    case $arg in
        --auto) AUTO_MODE="true" ;;
        --help) 
            echo "ARCB Wider Updater v$VERSION"
            echo "--------------------------------"
            echo "KullanÄ±m: guncel [SEÃ‡ENEK]"
            echo ""
            echo "SeÃ§enekler:"
            echo "  --auto    : Onay sormadan tam otomatik gÃ¼ncelleme yapar."
            echo "  --help    : Bu menÃ¼yÃ¼ gÃ¶sterir."
            echo ""
            echo "Log DosyasÄ±: $LOG_DIR/update_YYYYMMDD_HHMMSS.log"
            exit 0 ;;
    esac
done

check_root "$@"
setup_logging

if ! check_connectivity; then
    print_error "Ä°nternet baÄŸlantÄ±sÄ± kurulamadÄ±. Ä°ÅŸlem iptal."
    exit 1
fi

check_self_update "$@"

# FIX: Auto modda clear yapma, log akÄ±ÅŸÄ±nÄ± bozma
if [[ "$AUTO_MODE" != "true" ]]; then
    clear 
fi

echo -e "${GREEN}##################################################"
echo -e "   ARCB Wider Updater v$VERSION (Diamond Polish)"
echo -e "   Log: $LOG_FILE"
echo -e "   Mod: $( [[ "$AUTO_MODE" == "true" ]] && echo "Otomatik ðŸ¤–" || echo "Ä°nteraktif ðŸ‘¤" )"
echo -e "##################################################${NC}"

create_snapshot
perform_updates

print_header "SONUÃ‡"
print_success "Ä°ÅŸlem TamamlandÄ±."
echo -e "\n"
