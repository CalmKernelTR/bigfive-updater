# BigFive v6.2.0 "Chrom" — Feature Specification

> **Status:** Draft
> **Author:** Ahmet T. (ahm3t0t)
> **Date:** 2026-02-03
> **Edition:** BigFive
> **Codename:** Chrom (Server Automation)

---

## Executive Summary

v6.2.0 "Chrom" focuses on server automation features for system administrators. Three major features:

1. **Notification System** — Post-update alerts via Slack, Discord, Email
2. **Security-Only Mode** — Apply only security patches
3. **Pre/Post Update Hooks** — User-defined scripts before/after updates

---

## 1. Notification System

### 1.1 Overview

Send notifications after `--auto` mode updates complete. Supports multiple channels with fallback behavior.

### 1.2 Supported Channels

| Channel | Protocol | Use Case |
|---------|----------|----------|
| Slack | Webhook (HTTPS POST) | DevOps teams |
| Discord | Webhook (HTTPS POST) | Community/Home servers |
| Email | SMTP (TLS) | Traditional alerting |
| Generic HTTP | POST/GET | Custom integrations |

### 1.3 Configuration File

**Location:** `/etc/bigfive-updater/notify.conf`

```bash
# ============================================================
# BigFive Updater - Notification Configuration
# ============================================================

# Enable/disable notifications
NOTIFY_ENABLED=true

# Notification triggers (comma-separated)
# Options: success, error, security-only, always
NOTIFY_TRIGGER="success,error"

# -------------------- Slack --------------------
NOTIFY_SLACK_ENABLED=false
NOTIFY_SLACK_WEBHOOK="https://hooks.slack.com/services/XXX/YYY/ZZZ"
NOTIFY_SLACK_CHANNEL="#ops-alerts"
NOTIFY_SLACK_USERNAME="BigFive Bot"

# -------------------- Discord --------------------
NOTIFY_DISCORD_ENABLED=false
NOTIFY_DISCORD_WEBHOOK="https://discord.com/api/webhooks/XXX/YYY"

# -------------------- Email (SMTP) --------------------
NOTIFY_EMAIL_ENABLED=false
NOTIFY_EMAIL_TO="admin@example.com"
NOTIFY_EMAIL_FROM="bigfive@$(hostname -f)"
NOTIFY_EMAIL_SMTP_HOST="smtp.example.com"
NOTIFY_EMAIL_SMTP_PORT=587
NOTIFY_EMAIL_SMTP_USER=""
NOTIFY_EMAIL_SMTP_PASS=""
NOTIFY_EMAIL_SMTP_TLS=true

# -------------------- Generic HTTP --------------------
NOTIFY_HTTP_ENABLED=false
NOTIFY_HTTP_URL="https://example.com/webhook"
NOTIFY_HTTP_METHOD="POST"
NOTIFY_HTTP_HEADERS="Authorization: Bearer TOKEN"

# -------------------- Template --------------------
# Template file (optional, uses default if not set)
NOTIFY_TEMPLATE="/etc/bigfive-updater/notify-template.txt"

# -------------------- Fallback --------------------
# If primary channel fails, try these (comma-separated)
NOTIFY_FALLBACK="email"

# Timeout for webhook requests (seconds)
NOTIFY_TIMEOUT=30
```

### 1.4 Trigger Conditions

| Trigger | Description | Exit Code |
|---------|-------------|-----------|
| `success` | Update completed successfully | 0 |
| `error` | Update failed with error | 1-255 |
| `security-only` | Security updates applied | 0 |
| `always` | Send notification regardless | * |

### 1.5 Template System

**Default Template Variables:**

| Variable | Description | Example |
|----------|-------------|---------|
| `{{HOSTNAME}}` | Server hostname | srv1.example.com |
| `{{DATE}}` | ISO 8601 timestamp | 2026-02-03T14:30:00+03:00 |
| `{{STATUS}}` | Update status | SUCCESS / FAILED |
| `{{DISTRO}}` | Distribution name | Ubuntu 24.04 |
| `{{PKG_MANAGER}}` | Package manager used | APT |
| `{{UPDATED_COUNT}}` | Packages updated | 12 |
| `{{DURATION}}` | Update duration | 45s |
| `{{ERROR_CODE}}` | Error code (if failed) | E010 |
| `{{ERROR_MSG}}` | Error message | APT lock timeout |

**Default Template (Slack):**

```json
{
  "username": "BigFive Bot",
  "icon_emoji": ":penguin:",
  "attachments": [{
    "color": "{{STATUS_COLOR}}",
    "title": "BigFive Update Report",
    "fields": [
      {"title": "Host", "value": "{{HOSTNAME}}", "short": true},
      {"title": "Status", "value": "{{STATUS}}", "short": true},
      {"title": "Packages", "value": "{{UPDATED_COUNT}}", "short": true},
      {"title": "Duration", "value": "{{DURATION}}", "short": true}
    ],
    "footer": "BigFive Updater v{{VERSION}}",
    "ts": {{TIMESTAMP}}
  }]
}
```

### 1.6 Fallback Behavior

1. Try primary notification channel
2. If fails (timeout/error), try `NOTIFY_FALLBACK` channels in order
3. Log all attempts to `/var/log/bigfive-updater/notify.log`
4. Never block main update process for notification failures

### 1.7 CLI Flags

| Flag | Description |
|------|-------------|
| `--notify` | Force send notification (even if NOTIFY_ENABLED=false) |
| `--no-notify` | Suppress notifications for this run |
| `--notify-test` | Send test notification without running update |

### 1.8 Implementation Notes

```bash
# Function signature
send_notification() {
    local status="$1"      # SUCCESS, FAILED, SECURITY
    local details="$2"     # JSON object with update details

    # Load config
    [[ -f /etc/bigfive-updater/notify.conf ]] && source /etc/bigfive-updater/notify.conf

    # Check if notifications enabled
    [[ "$NOTIFY_ENABLED" != "true" ]] && return 0

    # Check trigger conditions
    should_notify "$status" || return 0

    # Try channels in order
    local sent=false
    for channel in slack discord email http; do
        if try_send_$channel "$status" "$details"; then
            sent=true
            break
        fi
    done

    # Fallback if primary failed
    if [[ "$sent" == "false" && -n "$NOTIFY_FALLBACK" ]]; then
        for fallback in ${NOTIFY_FALLBACK//,/ }; do
            try_send_$fallback "$status" "$details" && break
        done
    fi
}
```

---

## 2. Security-Only Mode (`--security-only`)

### 2.1 Overview

Apply only security updates, skipping feature updates. Critical for production servers that need security patches without risking stability.

### 2.2 Per-Distro Implementation

#### APT (Debian/Ubuntu)

```bash
# Method 1: unattended-upgrades style filtering
apt-get upgrade -y -o Dpkg::Options::="--force-confdef" \
    -o Dpkg::Options::="--force-confold" \
    $(apt-get --just-print upgrade 2>/dev/null | \
      grep -i security | awk '{print $2}')

# Method 2: Using apt-mark
apt-get install --only-upgrade $(apt list --upgradable 2>/dev/null | \
    grep -i "\-security" | cut -d/ -f1)
```

**Detection:** Check `/etc/apt/sources.list.d/*-security.list` or `-security` suffix

#### DNF (Fedora/RHEL)

```bash
# Native --security flag
dnf upgrade --security -y

# For advisory-based filtering
dnf updateinfo list security
dnf upgrade --advisory=FEDORA-2026-* -y
```

**Detection:** Native support, no additional logic needed

#### Zypper (openSUSE)

```bash
# Security patches only
zypper patch --category security -y

# Alternative: list then apply
zypper list-patches --category security
zypper patch --category security --with-interactive -y
```

**Detection:** Native support via `--category security`

#### Pacman (Arch Linux)

```bash
# Arch has no native security-only mode
# Option 1: Use arch-audit
if command -v arch-audit &>/dev/null; then
    # Get vulnerable packages
    VULN_PKGS=$(arch-audit -q 2>/dev/null)
    if [[ -n "$VULN_PKGS" ]]; then
        pacman -Sy --needed --noconfirm $VULN_PKGS
    fi
else
    echo "WARNING: arch-audit not installed, cannot filter security updates"
    echo "Install with: pacman -S arch-audit"
    return 1
fi
```

**Detection:** Requires `arch-audit` package (optional dependency)

#### APK (Alpine)

```bash
# Alpine has no native security-only filtering
# Security updates come through normal channels
echo "WARNING: APK does not support security-only filtering"
echo "All available updates will be applied"
# Fall back to normal upgrade or skip
```

**Detection:** Not supported — document limitation

### 2.3 Feature Matrix

| Distro | Native Support | Method | Notes |
|--------|----------------|--------|-------|
| APT | Partial | Source filtering | `-security` repo detection |
| DNF | Yes | `--security` flag | Full native support |
| Zypper | Yes | `--category security` | Patch-based |
| Pacman | No | `arch-audit` | Optional dependency |
| APK | No | N/A | Not supported |

### 2.4 CLI Flags

| Flag | Description |
|------|-------------|
| `--security-only` | Apply only security updates |
| `-S` | Short form of `--security-only` |

### 2.5 Config Option

```bash
# /etc/bigfive-updater.conf
CONFIG_SECURITY_ONLY=false    # Default to full updates
```

### 2.6 JSON Output Extension

```json
{
  "mode": "security-only",
  "security_updates": {
    "available": 5,
    "applied": 5,
    "skipped_feature": 12
  }
}
```

---

## 3. Pre/Post Update Hooks

### 3.1 Overview

Execute user-defined scripts before and after updates. Enables custom workflows like backups, service restarts, and notifications.

### 3.2 Directory Structure

```
/etc/bigfive-updater/
├── hooks.d/
│   ├── pre-update.d/
│   │   ├── 00-backup-db.sh
│   │   ├── 10-stop-services.sh
│   │   └── README
│   └── post-update.d/
│       ├── 00-start-services.sh
│       ├── 10-clear-cache.sh
│       ├── 90-send-report.sh
│       └── README
└── notify.conf
```

### 3.3 Hook Execution

**Execution Order:**
1. Scripts run in alphanumeric order (00-*, 10-*, etc.)
2. Use `run-parts` semantics
3. Scripts must be executable (`chmod +x`)

**Naming Convention:**
- `NN-description.sh` where NN is priority (00-99)
- Lower numbers run first
- Only `.sh` files are executed

### 3.4 Hook Environment

Scripts receive these environment variables:

| Variable | Description | Example |
|----------|-------------|---------|
| `BIGFIVE_VERSION` | BigFive version | 6.2.0 |
| `BIGFIVE_MODE` | Update mode | auto, interactive, dry-run |
| `BIGFIVE_DISTRO` | Distribution | ubuntu, fedora, arch |
| `BIGFIVE_PKG_MANAGER` | Package manager | apt, dnf, pacman |
| `BIGFIVE_SECURITY_ONLY` | Security mode | true, false |
| `BIGFIVE_DRY_RUN` | Dry run mode | true, false |
| `BIGFIVE_LOG_FILE` | Current log path | /var/log/bigfive-updater/... |

**Post-update only:**

| Variable | Description | Example |
|----------|-------------|---------|
| `BIGFIVE_STATUS` | Update status | SUCCESS, FAILED |
| `BIGFIVE_EXIT_CODE` | Exit code | 0, 1, etc. |
| `BIGFIVE_UPDATED_COUNT` | Packages updated | 12 |
| `BIGFIVE_DURATION` | Duration seconds | 45 |

### 3.5 Timeout and Error Handling

```bash
# Configuration
HOOKS_TIMEOUT=300          # 5 minutes per hook
HOOKS_FAIL_MODE="warn"     # warn, abort, ignore

# Execution
run_hooks() {
    local hook_dir="$1"
    local timeout="${HOOKS_TIMEOUT:-300}"

    [[ ! -d "$hook_dir" ]] && return 0

    for script in "$hook_dir"/*.sh; do
        [[ -x "$script" ]] || continue

        log_info "Running hook: $(basename "$script")"

        if ! timeout "$timeout" "$script"; then
            local exit_code=$?
            log_warn "Hook failed: $(basename "$script") (exit $exit_code)"

            case "$HOOKS_FAIL_MODE" in
                abort)
                    log_error "Hook failure, aborting update"
                    return 1
                    ;;
                warn)
                    log_warn "Continuing despite hook failure"
                    ;;
                ignore)
                    ;;
            esac
        fi
    done
}
```

### 3.6 CLI Flags

| Flag | Description |
|------|-------------|
| `--no-hooks` | Skip all hooks |
| `--hooks-timeout=N` | Override hook timeout (seconds) |

### 3.7 Config Options

```bash
# /etc/bigfive-updater.conf
CONFIG_HOOKS_ENABLED=true
CONFIG_HOOKS_TIMEOUT=300
CONFIG_HOOKS_FAIL_MODE="warn"    # warn, abort, ignore
```

### 3.8 Example Hook Scripts

**Pre-update: Database Backup**

```bash
#!/bin/bash
# /etc/bigfive-updater/hooks.d/pre-update.d/00-backup-db.sh

set -euo pipefail

BACKUP_DIR="/var/backups/bigfive"
mkdir -p "$BACKUP_DIR"

# PostgreSQL backup
if command -v pg_dumpall &>/dev/null; then
    pg_dumpall -U postgres > "$BACKUP_DIR/postgres-$(date +%Y%m%d).sql"
fi

# MySQL backup
if command -v mysqldump &>/dev/null; then
    mysqldump --all-databases > "$BACKUP_DIR/mysql-$(date +%Y%m%d).sql"
fi

exit 0
```

**Post-update: Restart Services**

```bash
#!/bin/bash
# /etc/bigfive-updater/hooks.d/post-update.d/00-restart-services.sh

set -euo pipefail

# Only restart if update was successful
[[ "$BIGFIVE_STATUS" != "SUCCESS" ]] && exit 0

# Restart web server if package was updated
if [[ -f /var/run/nginx.pid ]]; then
    systemctl reload nginx
fi

# Restart PHP-FPM if updated
if systemctl is-active --quiet php-fpm; then
    systemctl restart php-fpm
fi

exit 0
```

---

## 4. Dependency Map

```
┌─────────────────────────────────────────────────────────┐
│                    v6.2.0 "Chrom"                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────┐                                       │
│  │ Pre/Post     │◄───── Independent, implement first   │
│  │ Hooks        │                                       │
│  └──────┬───────┘                                       │
│         │                                               │
│         │ hooks can trigger notifications               │
│         ▼                                               │
│  ┌──────────────┐      ┌──────────────┐                │
│  │ Notification │◄─────│ Security-    │                │
│  │ System       │      │ Only Mode    │                │
│  └──────────────┘      └──────────────┘                │
│         ▲                     │                         │
│         │                     │                         │
│         └─────────────────────┘                         │
│           security-only triggers special notification   │
│                                                         │
└─────────────────────────────────────────────────────────┘

Implementation Order:
1. Pre/Post Hooks (no dependencies)
2. Security-Only Mode (independent)
3. Notification System (can integrate with both)
```

---

## 5. Effort Estimate

| Feature | New Lines | Modified Lines | Test Lines | Days |
|---------|-----------|----------------|------------|------|
| Notification System | ~400 | ~50 | ~80 | 3-4 |
| Security-Only Mode | ~200 | ~100 | ~60 | 2 |
| Pre/Post Hooks | ~150 | ~30 | ~50 | 1-2 |
| Documentation | ~300 | ~100 | — | 1 |
| **Total** | **~1050** | **~280** | **~190** | **7-9** |

**Assumptions:**
- Single developer
- Includes testing on all 5 distros
- Documentation in TR/EN

---

## 6. Test Plan

### 6.1 Notification System Tests

| ID | Test Case | Expected Result |
|----|-----------|-----------------|
| N01 | Slack webhook with valid URL | 200 OK, message posted |
| N02 | Slack webhook with invalid URL | Fallback triggered |
| N03 | Discord webhook | 204 No Content |
| N04 | Email SMTP (TLS) | Email delivered |
| N05 | Email SMTP (invalid creds) | Error logged, fallback |
| N06 | Generic HTTP POST | 200 OK |
| N07 | Template variable substitution | All vars replaced |
| N08 | Trigger: success only | No notification on error |
| N09 | Trigger: error only | No notification on success |
| N10 | Fallback chain | Secondary channel used |
| N11 | `--notify-test` | Test notification sent |
| N12 | `--no-notify` | No notification sent |
| N13 | Timeout handling | Notification aborted, update continues |

### 6.2 Security-Only Mode Tests

| ID | Test Case | Expected Result |
|----|-----------|-----------------|
| S01 | APT security filter | Only -security packages updated |
| S02 | DNF --security | Native flag used |
| S03 | Zypper --category security | Patch command used |
| S04 | Pacman with arch-audit | Vulnerable packages updated |
| S05 | Pacman without arch-audit | Warning, graceful skip |
| S06 | APK security mode | Warning, full update or skip |
| S07 | JSON output security mode | `mode: security-only` in output |
| S08 | Combined with --dry-run | No changes, security list shown |
| S09 | Config option | `CONFIG_SECURITY_ONLY=true` works |

### 6.3 Pre/Post Hooks Tests

| ID | Test Case | Expected Result |
|----|-----------|-----------------|
| H01 | Pre-hook execution order | 00-*, 10-*, 20-* order |
| H02 | Post-hook execution order | Same ordering |
| H03 | Hook timeout | Script killed after HOOKS_TIMEOUT |
| H04 | Hook failure (warn mode) | Warning logged, update continues |
| H05 | Hook failure (abort mode) | Update aborted |
| H06 | Hook failure (ignore mode) | No log, continues |
| H07 | Non-executable script | Skipped |
| H08 | Environment variables | All BIGFIVE_* vars set |
| H09 | `--no-hooks` flag | Hooks skipped |
| H10 | Empty hooks directory | No error |
| H11 | Missing hooks directory | Created on first run |

### 6.4 Integration Tests

| ID | Test Case | Expected Result |
|----|-----------|-----------------|
| I01 | Full flow: hooks + update + notify | All stages complete |
| I02 | Security-only + notification | Security notification sent |
| I03 | Hook failure + notification | Failure notification sent |
| I04 | Dry-run + hooks | Hooks run with DRY_RUN=true |
| I05 | Docker: Ubuntu + all features | Pass |
| I06 | Docker: Fedora + all features | Pass |
| I07 | Docker: Arch + all features | Pass |
| I08 | Docker: openSUSE + all features | Pass |
| I09 | Docker: Alpine + all features | Pass (with limitations) |

---

## 7. Migration Notes

### 7.1 Config File Changes

New config file: `/etc/bigfive-updater/notify.conf`

**install.sh updates:**
- Create `/etc/bigfive-updater/` directory
- Create `/etc/bigfive-updater/hooks.d/{pre,post}-update.d/`
- Install `notify.conf.example`

### 7.2 Backward Compatibility

- All new features are opt-in (disabled by default)
- Existing configs continue to work
- No breaking changes to CLI

### 7.3 New Dependencies

| Dependency | Required | Purpose |
|------------|----------|---------|
| curl | Yes (existing) | Webhook requests |
| jq | Recommended | JSON template processing |
| arch-audit | Optional (Arch only) | Security filtering |

---

## 8. Open Questions

1. **Notification retry policy:** How many retries before fallback?
2. **Hook parallelism:** Run hooks in parallel or sequential only?
3. **Notification rate limiting:** Prevent spam on frequent updates?
4. **Slack Block Kit:** Full support or simple messages only?

---

## 9. References

- [Slack Incoming Webhooks](https://api.slack.com/messaging/webhooks)
- [Discord Webhooks](https://discord.com/developers/docs/resources/webhook)
- [unattended-upgrades](https://wiki.debian.org/UnattendedUpgrades)
- [DNF Security Plugin](https://dnf-plugins-core.readthedocs.io/)
- [arch-audit](https://github.com/ilpianista/arch-audit)

---

*Document generated: 2026-02-03*
*BigFive Updater — https://github.com/CalmKernelTR/bigfive-updater*
